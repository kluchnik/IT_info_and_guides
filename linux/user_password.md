# Пароли пользователей

Описание три метода установки паролей:
* с использованием утилиты passwd
* с использованием реализации алгоритма шифрования passwd из библиотеки openssl
* с использованием функции crypt в программе на языке C

## Утилита passwd

Пароли пользователей могут устанавливаться с помощью утилиты passwd. При смене паролей пользователям придется предоставлять утилите свои старые пароли перед двукратным вводом новых паролей.

```
$: passwd
Изменяется пароль пользователя tania.
Смена пароля для tania.
(текущий) пароль UNIX:
Новый пароль :
НЕУДАЧНЫЙ ПАРОЛЬ: В пароле должно быть не меньше 8 символов
Новый пароль :
НЕУДАЧНЫЙ ПАРОЛЬ: Пароль является палиндромом
Новый пароль :
НЕУДАЧНЫЙ ПАРОЛЬ: Пароль слишком схож с предыдущим
passwd: Использовано максимальное число попыток, заданное для службы
```

Как вы видите, утилита passwd может выполнять простейшую проверку с целью предотвращения использования слишком простых паролей для учетных записей пользователей. Пользователь root не должен выполнять эти правила (хотя он и будет видеть предупреждения). Также пользователь root не должен вводить старый пароль перед двукратным вводом нового пароля.
```
$: passwd tania
Новый пароль :
Повторите ввод нового пароля :
passwd: все данные аутентификации успешно обновлены.
```

## Файл shadow

Пароли пользователей хранятся в зашифрованном виде в файле /etc/shadow. Файл /etc/shadow доступен только для чтения и может читаться исключительно пользователем root.

Файл /etc/shadow содержит таблицу с девятью разделенными двоеточиями столбцами. Эти девять столбцов (слева направо) содержат имя пользователя, зашифрованный пароль, время последнего изменения пароля (первый день соответствует 1 января 1970 года), количество дней, в течение которых пароль должен оставаться неизменным, день истечения срока действия пароля, количество дней перед истечением срока действия пароля, в течение которых должно выводиться предупреждение, количество дней после истечения срока действия пароля, по прошествии которых учетная запись должна быть отключена, а также день, когда учетная запись была отключена (также с начала 1970 года). Последнее поле пока не имеет значения.

## Шифрование ключевых фраз с помощью утилиты passwd

Пароли пользователей системы хранятся в зашифрованном формате. Их шифрование осуществляется средствами функции crypt. Простейший (и рекомендованный) способ добавления пользователя с заданным паролем в систему заключается в добавлении пользователя в систему с помощью команды ```useradd -m имя_пользователя``` с последующей установкой пароля с помощью утилиты ```passwd```.
```
$: useradd -m xavier
$: passwd xavier
Изменяется пароль пользователя xavier.
Новый пароль :
Повторите ввод нового пароля :
passwd: все данные аутентификации успешно обновлены.
```

## Шифрование ключевых фраз с помощью утилиты openssl

Другой способ создания учетных записей пользователей с паролями заключается в использовании параметра ```-p``` утилиты ```useradd```, но в случае использования данного параметра утилите необходимо передавать уже зашифрованный пароль. Вы можете зашифровать пароль с помощью команды ```openssl passwd```.

Команда ```openssl passwd``` позволяет сгенерировать несколько отдельных хэшей для одного и того же пароля, причем для этой цели используется значение ```salt```.
```
$: openssl passwd hunter2
86jcUNlnGDFpY
$: openssl passwd hunter2
Yj7mDO9OAnvq6
$: openssl passwd hunter2
YqDcJeGoDbzKA
```

Данное значение ```salt``` может быть выбрано произвольным образом и будет отображаться в виде двух первых символов хэша.
```
$: openssl passwd -salt 42 hunter2
42ZrbtP1Ze8G.
$: openssl passwd -salt 42 hunter2
42ZrbtP1Ze8G.
$: openssl passwd -salt 42 hunter2
42ZrbtP1Ze8G.
```

В данном примере показана методика создания учетной записи пользователя с паролем.
```
root@rhel65:~# useradd -m -p $(openssl passwd hunter2) mohamed
```

## Шифрование ключевых фраз с помощью функции crypt

Третий вариант заключается в создании вашей собственной программы на языке программирования C, которая будет использовать функцию crypt с ее последующей компиляции в бинарный файл.

```
$: cat MyCrypt.
```
```
#include <stdio.h>
#define __USE_XOPEN
#include <unistd.h>

int main(int argc, char** argv)
{
 if(argc==3)
   {
       printf("%s\n", crypt(argv[1],argv[2]));
   }
   else
   {
       printf("Использование: MyCrypt $пароль $salt\n" );
   }
  return 0;
}
```
Эта простая программа может быть скомпилирована средствами компилятора gcc с помощью команды, аналогичной следующей:
```
$: gcc MyCrypt.c -o MyCrypt -lcrypt
```
При использовании описанной программы MyCrypt нам придется передавать два параметра. Первым параметром является незашифрованный пароль, а вторым - значение salt. Значение salt используется для изменения алгоритма шифрования в соответствии с одним из 4096 различных вариантов. Данная вариация используется для предотвращения ситуаций, в которых два пользователя с одним и тем же паролем могут использовать одну и ту же запись в файле /etc/shadow.
```
$: ./MyCrypt hunter2 42
42ZrbtP1Ze8G.
$: ./MyCrypt hunter2 33
33d6taYSiEUXI
```

Обратили ли вы внимание на то, что первые два символа зашифрованного пароля являются значением salt?

Стандартный вывод функции crypt генерируется с использованием алгоритма DES, который давно устарел и может быть взломан за считанные минуты. Более предпочтительным алгоритмом для шифрования паролей является алгоритм md5, который может быть распознан по начальным символам значения salt $$.
```
$: ./MyCrypt hunter2 '$1$42'
$1$42$7l6Y3xT5282XmZrtDOF9f0
$: ./MyCrypt hunter2 '$6$42'
$6$42$OqFFAVnI3gTSYG0yI9TZWX9cpyQzwIop7HwpG1LLEsNBiMr4w6OvLX1KDa./UpwXfrFk1i...
```

Длина значения salt для алгоритма md5 может достигать восьми символов. Значения salt хранятся в открытом виде в строках файла /etc/shadow между вторым и третьим символами $, поэтому никогда не используйте строку пароля в качестве значения salt!
```
$: ./MyCrypt hunter2 '$1$hunter2'
$1$hunter2$YVxrxDmidq7Xf8Gdt6qM2.
```
